<html>
  <head>
    <script>
      function fadeIn(elementId) {
        const element = document.getElementById(elementId);
        element.classList.remove("hidden");
        element.style.opacity = "1";
        void element.offsetWidth;
        element.classList.add("visible");
        element.style.opacity = "1";
      }

      function fadeOut(elementId) {
        const element = document.getElementById(elementId);
        element.style.opacity = "0";
        setTimeout(() => {
          element.classList.add("hidden");
        }, 1500);
      }

      function toggleFade(elementId) {
        const element = document.getElementById(elementId);
        if (element.classList.contains("hidden")) {
          element.classList.remove("hidden");
          void element.offsetWidth;
          element.classList.add("visible");
          element.style.opacity = "1";
        } else {
          element.style.opacity = "0";
          setTimeout(() => {
            if (element.style.opacity === "0") {
              element.classList.remove("visible");
              element.classList.add("hidden");
            }
          }, 1000);
        }
      }
    </script>
    <title>Chat | Beat Saber Modding Wiki</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="/assets/logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@cometchat/chat-embed@1.x.x/dist/main.js"
    ></script>
    <style>
      .fade {
        opacity: 1;
        transition: opacity 1s ease;
      }
      .visible {
        display: block;
        opacity: 1;
      }
    </style>
  </head>
  <body style="overflow: hidden; background: black">
    <div
      style="z-index: -50"
      class="w-full h-full mt-0 m-0 border-0 fade rounded-none"
      id="chat"
    ></div>
    <script>
      window.addEventListener("DOMContentLoaded", (event) => {
        const COMETCHAT_CREDENTIALS = {
          appID: "16715605cbc276637",
          appRegion: "us",
          authKey: "e2aaea3afaa91a7a315164738582ee0a42e8202e",
        };
        const cometChat = CometChatApp.CometChat;
        const commandListenerId = "loginListener";
        const SUPPORT_UID = "support";
        const RECEIPT_TEXT = "Receved";

        function isLoginCommand(text = "") {
          return text.startsWith("/login");
        }

        function isReceiptMessage(text = "") {
          return text.trim() === RECEIPT_TEXT;
        }

        function sendReceipt() {
          const receiptMessage = new cometChat.TextMessage(
            SUPPORT_UID,
            RECEIPT_TEXT,
            cometChat.RECEIVER_TYPE.USER
          );
          cometChat
            .sendMessage(receiptMessage)
            .then(() => console.log("Receipt sent"))
            .catch((error) => console.error("Failed to send receipt:", error));
        }

        function handleCommand(text) {
          if (!isLoginCommand(text)) {
            return;
          }
          console.log("Command found:", text);
          const uid = text.replace("/login", "");
          localStorage.setItem("chatUser", uid);
          location.reload();
          sendReceipt();
        }

        function setupCommandDetection() {
          const messagesRequest = new cometChat.MessagesRequestBuilder()
            .setLimit(100)
            .setUID(SUPPORT_UID)
            .build();

          messagesRequest.fetchPrevious().then(
            (messages) => {
              const sortedMessages = [...messages].sort((a, b) => {
                const first =
                  typeof a.getSentAt === "function" ? a.getSentAt() : 0;
                const second =
                  typeof b.getSentAt === "function" ? b.getSentAt() : 0;
                return first - second;
              });

              const pendingCommands = [];

              sortedMessages.forEach((message) => {
                if (!(message instanceof cometChat.TextMessage)) {
                  return;
                }
                const text = (message.getText() || "").trim();
                if (isLoginCommand(text)) {
                  pendingCommands.push(text);
                  return;
                }
                if (isReceiptMessage(text) && pendingCommands.length) {
                  pendingCommands.shift();
                }
              });

              pendingCommands.forEach((commandText) => {
                handleCommand(commandText);
              });
            },
            (error) => {
              console.log("Error fetching messages:", error);
            }
          );

          // ensure duplicate listeners do not pile up on reload
          cometChat.removeMessageListener(commandListenerId);
          cometChat.addMessageListener(
            commandListenerId,
            new cometChat.MessageListener({
              onTextMessageReceived: (textMessage) => {
                const text = (textMessage.getText() || "").trim();
                if (isLoginCommand(text)) {
                  handleCommand(text);
                }
              },
            })
          );
        }

        let useruid =
          localStorage.getItem("chatUser") || generateRandomText(6);
        let usernew = localStorage.getItem("chatUser") === null;
        let userdisplay = "Guest (" + useruid + ")";
        let useravatar = "https://wiki.sm0ke.org/assets/logo.png";

        CometChatApp.init(COMETCHAT_CREDENTIALS)
          .then(() => {
            const user = new CometChatApp.CometChat.User(useruid);
            user.setName(userdisplay);
            user.setAvatar(useravatar);
            return CometChatApp.createOrUpdateUser(user);
          })
          .then((chatuser) => {
            localStorage.setItem("chatUser", chatuser.uid);
            return CometChatApp.login({ uid: chatuser.uid });
          })
          .then((loggedInUser) => {
            // Send automatic message to support
            const textMessage = new CometChatApp.CometChat.TextMessage(
              SUPPORT_UID, // receiver UID
              "Hello, I need assistance, my uid is " +
                loggedInUser.uid +
                "\n\nNote for user: If you get logged out, please use /login " +
                loggedInUser.uid +
                " to log back in", // message text
              CometChatApp.CometChat.RECEIVER_TYPE.USER
            );
            if (usernew) {
              CometChatApp.CometChat.sendMessage(textMessage)
                .then((message) => {
                  console.log("Auto message sent:", message);
                })
                .catch((error) => {
                  console.log("Message sending failed:", error);
                });
            }

            // Launch the widget
            return CometChatApp.launch({
              targetElementID: "chat",
              variantID: "6916997b5c867ddb852bdc2e",
              isDocked: false,
              height: "calc(100% + 1px)",
              width: "100%",
              roundedCorners: false,
              defaultID: "support",
              defaultType: "user",
            });
          })
          .then(() => {
            setupCommandDetection();
          })
          .catch((error) => console.error("[CometChat] Error:", error));
      });
      function generateRandomText(length) {
        const charset = "abcdefghijklmnopqrstuvwxyz0123456789";
        let randomText = "";
        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * charset.length);
          randomText += charset[randomIndex];
        }
        return randomText;
      }
    </script>
  </body>
</html>
